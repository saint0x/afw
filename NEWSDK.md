# Aria SDK & Toolchain: Implementation Plan

This document outlines the complete plan for creating the new Aria SDK and its underlying `arc` command-line toolchain. The goal is to provide a seamless, modern, and powerful developer experience for building and deploying agentic systems on the Aria Firmware.

## 1. Guiding Principles

-   **Developer Experience First**: The SDK and CLI must be intuitive, fast, and easy to use.
-   **`arc` as the Control Plane**: The `arc` CLI is the single source of truth for all platform interactions (build, validation, deployment).
-   **SDK as a Lightweight Wrapper**: The initial `@aria/sdk` will be a thin, programmatic wrapper around the `arc` CLI, enabling integration with other tools and scripts.
-   **Declarative Syntax**: All configuration is driven by the decorator syntax in `.ts` files, as defined in `SYNTAX.MD`.
-   **Secure by Default**: The toolchain will integrate the security and authentication model defined in `AUTH.MD`.

---

## 2. Standard Project Structure

The `arc new` command will scaffold the following directory structure. This standardization is key for the compiler and runtime to make intelligent assumptions.

```
my-aria-project/
├── src/
│   └── main.ts         # Main entry point with @aria, @tool, @agent decorators
├── config/
│   ├── package.json        # Project dependencies for 'bun install'
│   └── symphony.config.ts  # (Future) Advanced config for arc CLI
└── llm.xml               # (Optional) Advanced LLM prompt configurations
```

-   `manifest.json`: This is **not** part of the project structure. It is a build artifact generated by `arc build`.

---

## 3. `arc` CLI: The Control Plane

The `arc` executable (built from `ar-c`) is the core of the toolchain.

### `arc new <project-name>`
-   **Action**: Scaffolds a new project in the specified directory.
-   **Implementation**:
    -   Creates the standard project directories (`src/`, `config/`).
    -   Copies boilerplate files from embedded templates (user will provide).
    -   Initializes `package.json` with necessary dev dependencies (`@aria/sdk`, `typescript`).
    -   Initializes a `git` repository.

### `arc check`
-   **Action**: Statically analyzes the project for errors and validates configuration without creating a full bundle.
-   **Implementation**:
    -   Parses all `.ts` files and their decorators.
    -   Validates required fields in decorators.
    -   Verifies that all tools referenced by agents are defined.
    -   Verifies that all agents referenced by teams are defined.
    -   Checks for naming conflicts.
    -   Outputs a list of errors and warnings.

### `arc build`
-   **Action**: Compiles the TypeScript project into a distributable `.aria` bundle.
-   **Implementation**:
    -   Runs the `check` process first.
    -   **Manifest Generation**:
        -   Parses all decorators and generates `manifest.json` as defined in `ARC.MD`.
        -   Automatically extracts resource requirements and dependencies.
    -   **Source Bundling**:
        -   Copies relevant `.ts` source files into the bundle's `source/` directory.
    -   **Dependency Packaging**:
        -   Copies `package.json` into the bundle.
    -   **Packaging**:
        -   Archives all components (`manifest.json`, `source/`, `package.json`) into a single file (e.g., a ZIP archive with a `.aria` extension).
    -   **Signing & Checksum**:
        -   Calculates a `blake3` hash of the bundle contents.
        -   (Post-auth implementation) Signs the bundle hash.
        -   Appends the manifest, signature, and checksum to the bundle.

### `arc upload`
-   **Action**: Connects to the Aria Firmware and uploads the `.aria` bundle.
-   **Target Implementation** (gRPC via Quilt + Unix Socket):
    -   **Architecture**: Extends existing Quilt gRPC service with bundle upload RPCs
    -   **Transport**: Unix socket connection to Quilt daemon (`/var/run/aria/quilt.sock`)
    -   **Protocol**: Streaming gRPC upload for large bundles with progress reporting
    -   **Authentication**: Implements AUTH.MD cryptographic identity (`arianumber.json` + Ed25519)
    -   **Validation**: Blake3 checksums and signature verification before storage
    -   **Storage**: Direct integration with `pkg_store` for content-addressed storage
    -   **Observability**: Real-time upload progress via existing streaming infrastructure
-   **Current Implementation** (HTTP REST - Legacy):
    -   HTTP REST client with Bearer token authentication
    -   Will be maintained for development/compatibility during transition

---

## 4. `@aria/sdk`: The Node.js Wrapper

-   **Purpose**: To provide a programmatic API for developers who need to integrate `arc` commands into their own scripts or CI/CD pipelines.
-   **Implementation**:
    -   The SDK will be a simple Node.js package.
    -   It will locate the `arc` executable on the user's `PATH`.
    -   Each function (e.g., `sdk.build()`, `sdk.upload()`) will spawn `arc` as a child process with the appropriate arguments.
    -   It will capture `stdout` and `stderr` and return structured results (e.g., JSON objects) and `Promise`-based async flow.

---

## 5. Implementation Checklist

### Phase 1: Core Compiler & CLI (`ar-c`)

-   ✅ **Project Scaffolding (`arc new`)**
    -   ✅ Implement CLI command parsing for `new`.
    -   ✅ Embed basic project templates.
    -   ✅ Implement file creation and directory setup logic.

-   ✅ **Decorator Parsing & Validation (`arc check`)**
    -   ✅ Solidify the TypeScript AST parsing logic in `ar-c/src/compiler`.
    -   ✅ Implement robust validation for all decorator types (`@aria`, `@tool`, `@agent`, `@team`, `@pipeline`).
    -   ✅ Implement cross-reference validation (e.g., agent's `tools` array).
    -   ✅ Implement clear error reporting with file names and line numbers.

-   ✅ **Bundle Generation (`arc build`)**
    -   ✅ Implement `manifest.json` generation from parsed decorator data.
    -   ✅ Implement the `.aria` packaging logic (ZIP archive).
    -   ✅ Add `blake3` checksum generation for the bundle contents.

### Phase 2: Firmware Integration (`arc upload`)

-   ✅ **Upload Command (HTTP REST - Legacy)**
    -   ✅ HTTP REST client implementation with full upload logic
    -   ✅ Bundle validation and integrity checking  
    -   ✅ Server connectivity testing and error handling
    -   ✅ Bearer token authentication support
    -   ✅ Comprehensive error handling (401, 403, 413, 422, 5xx)
    -   ✅ Bundle size validation and server capability detection
    -   ✅ Upload progress reporting and response parsing

-   [ ] **gRPC Bundle Upload (Target Architecture)**
    -   ✅ **Phase 2.1: Protocol Extension**
        -   ✅ Extend `quilt.proto` with bundle upload RPCs (`UploadBundle`, `GetBundleInfo`, `ListBundles`)
        -   ✅ Define streaming upload message structures for large bundles
        -   ✅ Add bundle validation and status response types
        -   ✅ Update gRPC code generation in both Quilt and ar-c
    -   [ ] **Phase 2.2: Quilt Server Implementation**
        -   ✅ Implement gRPC bundle upload handlers in Quilt daemon
        -   ✅ Integrate with existing `pkg_store` for content-addressed storage
        -   ✅ Add Blake3 checksum validation and signature verification
        -   ✅ Stream large bundle uploads with progress reporting
    -   ✅ **Phase 2.3: ar-c Client Implementation**
        -   ✅ Add gRPC client dependencies (`tonic`, `prost`) to `ar-c`
        -   ✅ Implement Unix socket connection to Quilt daemon
        -   ✅ Replace HTTP upload with streaming gRPC upload
        -   ✅ Add progress reporting and error handling for gRPC transport
    -   [ ] **Phase 2.4: Bundle Format Enhancement**
        -   [ ] Add Blake3 checksums to `.aria` bundle format
        -   [ ] Implement bundle signing with Ed25519 cryptographic signatures
        -   [ ] Add source map generation for debugging and verification

-   [ ] **Authentication Integration (AUTH.MD)**
    -   [ ] Implement `arianumber.json` identity file discovery and parsing
    -   [ ] Add Ed25519 cryptography library (`ed25519-dalek`) to ar-c
    -   [ ] Implement challenge-response authentication protocol
    -   [ ] Replace Bearer token auth with cryptographic identity verification
    -   [ ] Add identity verification to Quilt daemon gRPC handlers

### Phase 3: SDK Wrapper (`@aria/sdk`)

-   [ ] **Package Setup**
    -   [ ] Set up a new Node.js project for the SDK.
    -   [ ] Configure TypeScript and build tooling (e.g., `tsc` or `tsup`).

-   [ ] **API Implementation**
    -   [ ] Implement the child process spawning logic to call `arc`.
    -   [ ] Create wrapper functions for `new()`, `check()`, `build()`, and `upload()`.
    -   [ ] Define clear TypeScript types for the inputs and outputs of each SDK function.

-   [ ] **Distribution**
    -   [ ] Publish the package to a registry (e.g., npm).

### Phase 4: Documentation & Polish

-   [ ] **CLI Help Menus**: Ensure every `arc` command has a detailed `--help` output.
-   [ ] **SDK Documentation**: Write comprehensive TSDoc comments for all exported SDK functions and types.
-   [ ] **Developer Guide**: Create a `DEVELOPMENT.md` that walks a user through the `arc new` -> `arc build` -> `arc upload` workflow.
-   [ ] **Update `SYNTAX.MD`**: Finalize `SYNTAX.MD` as the official reference for all decorator configurations. 